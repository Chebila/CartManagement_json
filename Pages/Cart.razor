@page "/cart"
@using ECommerceApp.Models
@inject ECommerceApp.ViewModels.CartViewModel CartVM

<h3 class="mb-4">Your Cart</h3>

@if (CartVM.Items == null)
{
    <p>Loading...</p>
}
else if (!CartVM.Items.Any())
{
    <div class="alert alert-info">Your cart is empty.</div>
}
else
{
    <div class="row g-3">
        @foreach (var (item, product) in CartVM.Items)
        {
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm">
                    @if (!string.IsNullOrEmpty(product?.ImageUrl))
                    {
                        <img src="@product.ImageUrl" class="card-img-top" alt="@product?.Name" style="object-fit:contain; height:180px; background:#fafafa;" />
                    }
                    else
                    {
                        <div class="card-img-top d-flex align-items-center justify-content-center" style="height:180px; background:#f6f6f6;">
                            <span class="text-secondary">No Image</span>
                        </div>
                    }
                    <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-2">
                        @(
                                            !string.IsNullOrEmpty(product?.Name)
                                            ? product.Name
                                            : (MarkupString)"<span class='text-danger'>(deleted product)</span>"
                                            )
                    </h5>
                        <p class="card-text text-muted small mb-2">@product?.Description</p>
                        <div class="mb-2">
                        <span class="fw-bold text-success">
                            @(product != null ? product.Price.ToString("C") : "-")
                        </span>
                            <span class="mx-2">x</span>
                            <input type="number"
                                   class="form-control form-control-sm d-inline text-center"
                                   style="width:70px; display:inline;"
                                   min="0"
                                   value="@item.Quantity"
                                   @onchange="(e) => OnQtyChange(item.ProductId, e.Value?.ToString())" />
                        </div>
                        <div class="mb-2">
                        <span>Subtotal: <b>@(product != null ? (product.Price * item.Quantity).ToString("C") : "-")</b></span>
                        </div>
                        <div class="mt-auto">
                            <button class="btn btn-danger btn-sm w-100" @onclick="() => OnRemove(item.ProductId)">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
        <h5>Total: <span class="badge bg-success fs-5">@CartVM.CartTotal.ToString("C")</span></h5>
        <button class="btn btn-outline-danger" @onclick="OnClear">
            <i class="bi bi-x-circle"></i> Clear cart
        </button>
    </div>
}

@code {
    protected override void OnInitialized()
    {
        CartVM.LoadCart();
    }

    void OnQtyChange(string productId, string? value)
    {
        if (int.TryParse(value, out var q))
        {
            CartVM.UpdateQuantity(productId, q);
            StateHasChanged();
        }
    }

    void OnRemove(string id)
    {
        CartVM.Remove(id);
    }

    void OnClear()
    {
        CartVM.Clear();
    }
}